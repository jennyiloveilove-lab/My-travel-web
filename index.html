<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>東京旅遊助手 Pro (HKD & Shopping)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        body { background-color: #f8fafc; font-family: -apple-system, sans-serif; }
        .app-container { max-width: 480px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; padding-bottom: 100px; }
        .img-preview { width: 100%; height: 180px; object-fit: cover; border-radius: 12px; margin-top: 8px; border: 1px solid #eee; }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        .strikethrough { text-decoration: line-through; opacity: 0.5; }
    </style>
</head>
<body>

<div id="app" class="app-container">
    <header class="bg-rose-500 text-white p-6 rounded-b-[2rem] shadow-lg sticky top-0 z-20">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold italic">Tokyo Pro <i class="fa-solid fa-plane"></i></h1>
                <p class="text-xs opacity-90 font-medium">1 JPY = {{ exchangeRate }} HKD</p>
            </div>
            <button @click="resetData" class="bg-white/20 p-2 rounded-full hover:bg-white/40"><i class="fa-solid fa-trash-can"></i></button>
        </div>
    </header>

    <main class="p-4">
        <div v-if="currentView === 'itinerary'">
            <div class="flex space-x-2 overflow-x-auto no-scrollbar mb-4">
                <button v-for="(day, i) in itinerary" :key="i" @click="activeDayIdx = i"
                    :class="activeDayIdx === i ? 'bg-rose-500 text-white shadow-md' : 'bg-gray-100 text-gray-500'"
                    class="px-5 py-2 rounded-full text-sm font-bold flex-shrink-0 transition-all">
                    Day {{ i + 1 }}
                </button>
                <button @click="addDay" class="px-4 py-2 bg-rose-50 text-rose-500 rounded-full border border-rose-100"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div class="space-y-4">
                <div v-if="itinerary[activeDayIdx].events.length === 0" class="text-center py-20 text-gray-300">
                    <i class="fa-solid fa-map-location-dot text-5xl mb-4"></i>
                    <p>這天還沒排行程喔！</p>
                </div>
                <div v-for="(event, eIdx) in itinerary[activeDayIdx].events" :key="eIdx" class="bg-white border border-gray-100 rounded-2xl p-4 shadow-sm">
                    <div class="flex justify-between items-start">
                        <span class="text-[10px] font-black text-rose-500 bg-rose-50 px-2 py-1 rounded-md">{{ event.time }}</span>
                        <div class="flex gap-4 text-gray-400">
                            <i @click="openMap(event.location)" class="fa-solid fa-location-dot hover:text-blue-500 text-lg"></i>
                            <i @click="deleteEvent(eIdx)" class="fa-solid fa-xmark hover:text-red-500 text-lg"></i>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-800 text-lg mt-2">{{ event.location }}</h3>
                    <p class="text-gray-500 text-sm mt-1 whitespace-pre-wrap">{{ event.note }}</p>
                    <img v-if="event.image" :src="event.image" class="img-preview" @click="previewImg(event.image)">
                </div>
            </div>
            <button @click="showEventModal = true" class="fixed bottom-28 right-6 bg-rose-500 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-xl z-30"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-else-if="currentView === 'shopping'">
            <div class="flex justify-between items-center mb-4 px-1">
                <h2 class="text-xl font-bold text-gray-800 underline decoration-emerald-400 decoration-4">想買清單</h2>
                <span class="text-xs bg-emerald-100 text-emerald-600 px-2 py-1 rounded-lg font-bold">已完成 {{ shoppingList.filter(i => i.done).length }}/{{ shoppingList.length }}</span>
            </div>
            
            <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden mb-6">
                <div v-for="(item, idx) in shoppingList" :key="idx" 
                    class="flex items-center p-4 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors"
                    @click="item.done = !item.done">
                    <div class="mr-4">
                        <i v-if="item.done" class="fa-solid fa-circle-check text-emerald-500 text-xl"></i>
                        <i v-else class="fa-regular fa-circle text-gray-300 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-gray-800" :class="{ 'strikethrough': item.done }">{{ item.name }}</p>
                        <p v-if="item.note" class="text-xs text-gray-400">{{ item.note }}</p>
                    </div>
                    <i @click.stop="shoppingList.splice(idx, 1)" class="fa-solid fa-trash text-gray-200 hover:text-red-300 ml-2"></i>
                </div>
                <div v-if="shoppingList.length === 0" class="p-10 text-center text-gray-300 italic text-sm">
                    清單係空嘅，快啲去補貨！
                </div>
            </div>

            <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                <p class="text-xs font-bold text-emerald-600 mb-2 uppercase tracking-widest">快速新增項目</p>
                <div class="flex gap-2">
                    <input v-model="newItem.name" @keyup.enter="addShoppingItem" type="text" placeholder="例如：合利他命" class="flex-1 p-3 rounded-xl border-none outline-none focus:ring-2 focus:ring-emerald-400">
                    <button @click="addShoppingItem" class="bg-emerald-500 text-white px-5 rounded-xl font-bold">Add</button>
                </div>
            </div>
        </div>

        <div v-else-if="currentView === 'expenses'">
            <div class="bg-slate-800 p-6 rounded-3xl text-white shadow-xl mb-6">
                <p class="text-[10px] text-slate-400 font-bold tracking-widest uppercase mb-1">總預算消耗 (HKD)</p>
                <h2 class="text-3xl font-bold tracking-tight">HK$ {{ Math.round(totalExpense * exchangeRate).toLocaleString() }}</h2>
                
                <div class="mt-5 pt-5 border-t border-slate-700">
                    <p class="text-xs font-bold text-rose-400 mb-3"><i class="fa-solid fa-hand-holding-dollar mr-1"></i> 結算清單：</p>
                    <div v-for="debt in debts" class="bg-slate-700/50 p-3 rounded-xl mb-2 flex justify-between items-center text-sm border border-slate-700">
                        <span><b class="text-rose-300">{{ debt.from }}</b> 給 <b class="text-emerald-300">{{ debt.to }}</b></span>
                        <span class="font-mono font-bold">¥{{ Math.round(debt.amount).toLocaleString() }}</span>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <div v-for="(exp, i) in expenses" :key="i" class="flex justify-between items-center p-4 bg-white border border-gray-100 rounded-2xl shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center font-bold text-slate-500">{{ exp.payer[0] }}</div>
                        <div><p class="font-bold text-gray-800">{{ exp.title }}</p><p class="text-[10px] text-gray-400 uppercase">{{ exp.payer }} 已付 ¥{{ exp.amount }}</p></div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-rose-500">HK$ {{ (exp.amount * exchangeRate).toFixed(1) }}</p>
                        <button @click="expenses.splice(i, 1)" class="text-[10px] text-gray-300 hover:text-red-400">移除</button>
                    </div>
                </div>
            </div>
            <button @click="showExpenseModal = true" class="fixed bottom-28 right-6 bg-slate-800 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-xl z-30"><i class="fa-solid fa-receipt"></i></button>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t flex justify-around py-4 pb-8 max-w-[480px] mx-auto z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <div @click="currentView = 'itinerary'" :class="currentView === 'itinerary' ? 'text-rose-500' : 'text-gray-300'" class="text-center w-1/3 cursor-pointer">
            <i class="fa-solid fa-map-pin text-xl"></i><p class="text-[10px] font-bold mt-1">行程</p>
        </div>
        <div @click="currentView = 'shopping'" :class="currentView === 'shopping' ? 'text-emerald-500' : 'text-gray-300'" class="text-center w-1/3 cursor-pointer">
            <i class="fa-solid fa-bag-shopping text-xl"></i><p class="text-[10px] font-bold mt-1">購物</p>
        </div>
        <div @click="currentView = 'expenses'" :class="currentView === 'expenses' ? 'text-slate-800' : 'text-gray-300'" class="text-center w-1/3 cursor-pointer">
            <i class="fa-solid fa-wallet text-xl"></i><p class="text-[10px] font-bold mt-1">分帳</p>
        </div>
    </nav>

    <div v-if="showEventModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end">
        <div class="bg-white w-full rounded-t-[2.5rem] p-8 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-2xl text-gray-800">新增行程</h3><i @click="showEventModal = false" class="fa-solid fa-circle-xmark text-gray-300 text-2xl cursor-pointer"></i></div>
            <div class="space-y-4">
                <input v-model="newEvent.time" type="time" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100 outline-none">
                <input v-model="newEvent.location" type="text" placeholder="地點名稱" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100 outline-none">
                <textarea v-model="newEvent.note" placeholder="備註..." class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100 outline-none h-24"></textarea>
                <label class="flex items-center justify-center w-full p-4 border-2 border-dashed border-gray-200 rounded-2xl text-gray-400 cursor-pointer hover:bg-gray-50">
                    <i class="fa-solid fa-camera mr-2"></i> {{ newEvent.image ? '已選取相片' : '上傳憑證/地圖' }}
                    <input type="file" @change="handleFileUpload" class="hidden" accept="image/*">
                </label>
            </div>
            <button @click="saveEvent" class="w-full bg-rose-500 text-white py-4 rounded-2xl font-bold shadow-lg mt-6">加入行程</button>
        </div>
    </div>

    <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end">
        <div class="bg-white w-full rounded-t-[2.5rem] p-8 animate-slide-up">
            <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-2xl text-gray-800">記帳 (JPY)</h3><i @click="showExpenseModal = false" class="fa-solid fa-circle-xmark text-gray-300 text-2xl cursor-pointer"></i></div>
            <input v-model="newExpense.title" type="text" placeholder="支出項目" class="w-full mb-4 p-4 bg-gray-50 rounded-2xl border border-gray-100">
            <div class="relative mb-4">
                <input v-model="newExpense.amount" type="number" placeholder="金額 (日圓)" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100">
                <div class="absolute right-4 top-4 text-sm text-rose-500 font-bold">≈ HK$ {{ (newExpense.amount * exchangeRate).toFixed(1) }}</div>
            </div>
            <div class="flex flex-wrap gap-2 mb-8">
                <button v-for="m in members" @click="newExpense.payer = m" 
                    :class="newExpense.payer === m ? 'bg-slate-800 text-white shadow-md':'bg-gray-100 text-gray-500'" 
                    class="px-5 py-2 rounded-xl text-sm font-bold transition-all">{{ m }}</button>
            </div>
            <button @click="saveExpense" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold">儲存紀錄</button>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;
createApp({
    data() {
        return {
            currentView: 'itinerary',
            activeDayIdx: 0,
            showEventModal: false,
            showExpenseModal: false,
            exchangeRate: 0.052,
            members: ['我', '旅伴A'],
            itinerary: [{ date: 'Day 1', events: [] }],
            expenses: [],
            shoppingList: [],
            newItem: { name: '', note: '', done: false },
            newEvent: { time: '', location: '', note: '', image: null },
            newExpense: { title: '', amount: '', payer: '我' }
        }
    },
    computed: {
        totalExpense() { return this.expenses.reduce((s, e) => s + Number(e.amount), 0); },
        debts() {
            let balance = {}; this.members.forEach(m => balance[m] = 0);
            this.expenses.forEach(e => {
                let share = Number(e.amount) / this.members.length;
                this.members.forEach(m => balance[m] -= share);
                balance[e.payer] += Number(e.amount);
            });
            let trans = [];
            let debtors = Object.keys(balance).filter(m => balance[m] < -0.1).sort((a,b) => balance[a]-balance[b]);
            let creditors = Object.keys(balance).filter(m => balance[m] > 0.1).sort((a,b) => balance[b]-balance[a]);
            let b_copy = {...balance};
            debtors.forEach(d => { creditors.forEach(c => {
                    let amt = Math.min(Math.abs(b_copy[d]), b_copy[c]);
                    if(amt > 0.1) { trans.push({ from: d, to: c, amount: amt }); b_copy[d] += amt; b_copy[c] -= amt; }
            });});
            return trans;
        }
    },
    watch: {
        itinerary: { handler() { this.saveToLocal() }, deep: true },
        expenses: { handler() { this.saveToLocal() }, deep: true },
        shoppingList: { handler() { this.saveToLocal() }, deep: true }
    },
    methods: {
        addDay() { this.itinerary.push({ date: `Day ${this.itinerary.length+1}`, events: [] }); this.activeDayIdx = this.itinerary.length - 1; },
        addShoppingItem() { if(!this.newItem.name) return; this.shoppingList.unshift({...this.newItem}); this.newItem = { name: '', note: '', done: false }; },
        handleFileUpload(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (f) => { this.newEvent.image = f.target.result; };
            reader.readAsDataURL(file);
        },
        saveEvent() {
            if(!this.newEvent.location) return;
            this.itinerary[this.activeDayIdx].events.push({...this.newEvent});
            this.itinerary[this.activeDayIdx].events.sort((a,b) => a.time.localeCompare(b.time));
            this.newEvent = { time: '', location: '', note: '', image: null };
            this.showEventModal = false;
        },
        deleteEvent(idx) { if(confirm('刪除？')) this.itinerary[this.activeDayIdx].events.splice(idx, 1); },
        saveExpense() {
            if(!this.newExpense.amount) return;
            this.expenses.unshift({...this.newExpense});
            this.newExpense = { title: '', amount: '', payer: '我' };
            this.showExpenseModal = false;
        },
        openMap(loc) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank'); },
        saveToLocal() { localStorage.setItem('tokyo_final_data', JSON.stringify({ i: this.itinerary, e: this.expenses, s: this.shoppingList })); },
        resetData() { if(confirm('確定清空所有資料？')) { localStorage.removeItem('tokyo_final_data'); location.reload(); } }
    },
    mounted() {
        const saved = JSON.parse(localStorage.getItem('tokyo_final_data'));
        if(saved) { this.itinerary = saved.i; this.expenses = saved.e; this.shoppingList = saved.s || []; }
    }
}).mount('#app');
</script>
</body>
</html>