<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±äº¬æ—…æ—¥è¨˜ Pro ğŸŒ¸</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f0f9f9; font-family: 'Zen Maru Gothic', sans-serif; color: #2d5a5a; overflow-x: hidden; }
        .app-container { max-width: 480px; margin: 0 auto; background: #ffffff; min-height: 100vh; position: relative; padding-bottom: 100px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æ‹–ç§»æ¨£å¼ */
        .sortable-ghost { opacity: 0.3; transform: scale(0.95); background: #e0f2f2 !important; }
        .sortable-drag { cursor: grabbing; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        .kawaii-card { 
            border-radius: 20px; border: 2px solid #f0f9f9; background: #fff; 
            transition: transform 0.1s; user-select: none; touch-action: manipulation;
        }
        .type-tag { font-size: 10px; padding: 2px 8px; rounded: 10px; font-weight: bold; }
        .bg-aqua { background-color: #64cccc; }
        .scroll-y-container { height: calc(100vh - 280px); overflow-y: auto; }
    </style>
</head>
<body>

<div id="app" class="app-container">
    <header class="bg-aqua text-white p-6 rounded-b-[2.5rem] shadow-lg sticky top-0 z-20">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-xl font-bold flex items-center gap-2">
                    {{ currentTime }} <span class="text-xs opacity-80">Tokyo</span>
                </h1>
                <div class="flex items-center mt-2 text-sm bg-white/20 p-2 rounded-xl">
                    <i v-if="weather" :class="getWeatherIcon(weather.code)" class="text-xl mr-2"></i>
                    <div v-if="weather">
                        <p class="font-bold">{{ weather.temp }}Â°C</p>
                        <p class="text-[10px] opacity-90">{{ travelTip }}</p>
                    </div>
                </div>
            </div>
            <button @click="showDateSettings = true" class="bg-white/30 p-2 rounded-full"><i class="fa-solid fa-calendar"></i></button>
        </div>

        <div class="flex space-x-2 overflow-x-auto no-scrollbar mt-4 py-1">
            <button v-for="(day, i) in itinerary" :key="i" @click="activeDayIdx = i"
                :class="activeDayIdx === i ? 'bg-white text-aqua' : 'bg-white/20 text-white'"
                class="px-4 py-2 rounded-xl text-xs font-bold flex-shrink-0 transition-all">
                {{ getDisplayDate(i) }} ({{ getDayOfWeek(i) }})
            </button>
            <button @click="addDay" class="px-3 py-2 bg-white/10 rounded-xl"><i class="fa-solid fa-plus text-xs"></i></button>
        </div>
    </header>

    <main class="p-4">
        <div class="scroll-y-container no-scrollbar" ref="sortableList">
            <div v-for="(event, eIdx) in itinerary[activeDayIdx].events" :key="event.id" 
                class="kawaii-card p-4 mb-4 shadow-sm relative active:scale-95"
                @click="openEditModal(eIdx)">
                
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-aqua bg-aqua/10 px-2 py-1 rounded-lg">{{ event.time }}</span>
                        <span :class="getTypeClass(event.type)" class="type-tag uppercase">{{ event.type }}</span>
                    </div>
                    <div class="text-[10px] font-bold text-rose-400" v-if="event.cost > 0">
                        Â¥{{ event.cost.toLocaleString() }}
                    </div>
                </div>
                
                <h3 class="text-md font-bold text-[#2d5a5a] mt-2 flex items-center gap-2">
                    <i :class="getTypeIcon(event.type)" class="text-aqua/50"></i>
                    {{ event.location }}
                </h3>
                <p v-if="event.note" class="text-xs text-[#88babb] mt-1 line-clamp-1 italic">"{{ event.note }}"</p>
                
                <div class="flex justify-end gap-3 mt-2">
                    <i @click.stop="openMap(event.location)" class="fa-solid fa-map-location-dot text-[#88babb] hover:text-blue-400"></i>
                </div>
            </div>
        </div>

        <div class="mt-4 p-4 bg-[#f0f9f9] rounded-2xl border-2 border-dashed border-aqua flex justify-between items-center">
            <span class="text-xs font-bold text-aqua uppercase">Today's Cost</span>
            <span class="font-bold text-[#2d5a5a]">Â¥ {{ dayTotalCost.toLocaleString() }} <small class="text-[10px] opacity-60">â‰ˆ HK${{ (dayTotalCost * exchangeRate).toFixed(0) }}</small></span>
        </div>
    </main>

    <button @click="addNewEvent" class="fixed bottom-24 right-6 bg-aqua text-white w-14 h-14 rounded-full shadow-xl z-30 flex items-center justify-center transition-transform active:rotate-90">
        <i class="fa-solid fa-plus text-2xl"></i>
    </button>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t flex justify-around py-4 pb-8 max-w-[480px] mx-auto z-40">
        <div @click="currentView = 'itinerary'" class="text-aqua text-center w-1/3"><i class="fa-solid fa-map-pin text-xl"></i></div>
        <div @click="currentView = 'shopping'" class="text-gray-300 text-center w-1/3"><i class="fa-solid fa-bag-shopping text-xl"></i></div>
        <div @click="currentView = 'expenses'" class="text-gray-300 text-center w-1/3"><i class="fa-solid fa-chart-pie text-xl"></i></div>
    </nav>

    <div v-if="showEditModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end">
        <div class="bg-white w-full rounded-t-[2.5rem] p-6 shadow-2xl animate-slide-up border-t-8 border-aqua max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">{{ isNew ? 'âœ¨ æ–°å¢è¡Œç¨‹' : 'ğŸ“ ç·¨è¼¯è¡Œç¨‹' }}</h3>
                <i @click="showEditModal = false" class="fa-solid fa-circle-xmark text-gray-200 text-2xl"></i>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-aqua uppercase ml-1">æ™‚é–“ & åœ°é»</label>
                    <div class="flex gap-2">
                        <input v-model="editingEvent.time" type="time" class="p-3 bg-gray-50 rounded-xl border-none outline-none text-sm w-32">
                        <input v-model="editingEvent.location" type="text" placeholder="ç›®çš„åœ°åç¨±" class="flex-1 p-3 bg-gray-50 rounded-xl border-none outline-none text-sm font-bold">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-aqua uppercase ml-1">è¡Œç¨‹æ€§è³ª</label>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar py-1">
                        <button v-for="t in categories" @click="editingEvent.type = t.n"
                            :class="editingEvent.type === t.n ? 'bg-aqua text-white shadow-md' : 'bg-gray-100 text-gray-400'"
                            class="px-4 py-2 rounded-xl text-xs font-bold flex-shrink-0 transition-all">
                            {{ t.e }} {{ t.n }}
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-aqua uppercase ml-1">è¨˜å¸³ (JPY)</label>
                        <input v-model.number="editingEvent.cost" type="number" placeholder="Â¥ 0" class="w-full p-3 bg-rose-50 text-rose-500 rounded-xl font-bold outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-aqua uppercase ml-1">é è¦½ (HKD)</label>
                        <div class="p-3 bg-gray-50 rounded-xl text-sm font-bold text-gray-400">â‰ˆ ${{ (editingEvent.cost * exchangeRate).toFixed(0) }}</div>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-aqua uppercase ml-1">ç­†è¨˜ / Note</label>
                    <textarea v-model="editingEvent.note" placeholder="æœ‰å’©è¦è¨˜ä½ï¼Ÿ(ä¾‹å¦‚ï¼šå¿…é£Ÿæ¨ä»‹)" class="w-full p-3 bg-gray-50 rounded-xl border-none outline-none text-xs h-20"></textarea>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button v-if="!isNew" @click="deleteCurrentEvent" class="flex-1 py-4 rounded-2xl font-bold text-rose-300 bg-rose-50">åˆªé™¤</button>
                <button @click="saveEdit" class="flex-[2] bg-aqua text-white py-4 rounded-2xl font-bold shadow-lg">å„²å­˜è¡Œç¨‹</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;
createApp({
    data() {
        return {
            currentView: 'itinerary',
            activeDayIdx: 0,
            showEditModal: false,
            isNew: false,
            editingIdx: -1,
            currentTime: '',
            startDate: new Date().toISOString().substr(0, 10),
            exchangeRate: 0.052,
            weather: null,
            categories: [
                {n: 'æ™¯é»', e: 'ğŸ¯'}, {n: 'åƒé£¯', e: 'ğŸ±'}, 
                {n: 'é€›è¡—', e: 'ğŸ›ï¸'}, {n: 'äº¤é€š', e: 'ğŸšƒ'}, {n: 'å½ˆæ€§', e: 'âœ¨'}
            ],
            itinerary: [{ events: [] }],
            editingEvent: { id: 0, time: '10:00', location: '', type: 'æ™¯é»', cost: 0, note: '' },
            shoppingList: [],
            expenses: []
        }
    },
    computed: {
        dayTotalCost() {
            return this.itinerary[this.activeDayIdx].events.reduce((s, e) => s + (Number(e.cost) || 0), 0);
        },
        travelTip() {
            if (!this.weather) return "æ­£åœ¨ç²å–æ±äº¬å¤©æ°£...";
            const code = this.weather.code;
            if (code === 0) return "â˜€ï¸ å¤©æ°£æ™´æœ—ï¼Œéå¸¸é©åˆæˆ¶å¤–æ™¯é»ï¼è¨˜å¾—é˜²æ›¬ã€‚";
            if (code < 4) return "â˜ï¸ é›–ç„¶æœ‰é›²ï¼Œä½†å®¤å¤–æ•£æ­¥ä¹Ÿå¾ˆèˆ’æœå–”ã€‚";
            if (code >= 51) return "â˜” ä¸‹é›¨äº†ï¼Œå»ºè­°æ”¹èµ°ç™¾è²¨å…¬å¸æˆ–åœ°ä¸‹è¡—è¡Œç¨‹ã€‚";
            return "ç¥ä½ æœ‰å€‹ç¾å¥½çš„ä¸€å¤©ï¼";
        }
    },
    methods: {
        updateTime() {
            const now = new Date();
            this.currentTime = now.toLocaleTimeString('zh-HK', { hour12: false, hour: '2-digit', minute: '2-digit' });
        },
        async fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&current_weather=true');
                const data = await res.json();
                this.weather = { temp: Math.round(data.current_weather.temperature), code: data.current_weather.weathercode };
            } catch (e) { console.error(e); }
        },
        getDisplayDate(i) {
            const d = new Date(this.startDate); d.setDate(d.getDate() + i);
            return `${d.getMonth() + 1}/${d.getDate()}`;
        },
        getDayOfWeek(i) {
            const d = new Date(this.startDate); d.setDate(d.getDate() + i);
            return d.toLocaleDateString('zh-HK', { weekday: 'short' });
        },
        openEditModal(idx) {
            this.isNew = false;
            this.editingIdx = idx;
            this.editingEvent = JSON.parse(JSON.stringify(this.itinerary[this.activeDayIdx].events[idx]));
            this.showEditModal = true;
        },
        addNewEvent() {
            this.isNew = true;
            this.editingEvent = { id: Date.now(), time: '12:00', location: '', type: 'æ™¯é»', cost: 0, note: '' };
            this.showEditModal = true;
        },
        saveEdit() {
            if(!this.editingEvent.location) return;
            if(this.isNew) {
                this.itinerary[this.activeDayIdx].events.push({...this.editingEvent});
            } else {
                this.itinerary[this.activeDayIdx].events[this.editingIdx] = {...this.editingEvent};
            }
            this.itinerary[this.activeDayIdx].events.sort((a,b) => a.time.localeCompare(b.time));
            this.showEditModal = false;
            this.saveToLocal();
        },
        deleteCurrentEvent() {
            this.itinerary[this.activeDayIdx].events.splice(this.editingIdx, 1);
            this.showEditModal = false;
            this.saveToLocal();
        },
        addDay() { this.itinerary.push({ events: [] }); this.activeDayIdx = this.itinerary.length - 1; },
        getTypeClass(t) {
            const maps = {'æ™¯é»':'bg-blue-100 text-blue-500','åƒé£¯':'bg-orange-100 text-orange-500','é€›è¡—':'bg-pink-100 text-pink-500','äº¤é€š':'bg-gray-100 text-gray-500','å½ˆæ€§':'bg-purple-100 text-purple-500'};
            return maps[t] || 'bg-gray-100';
        },
        getTypeIcon(t) {
            const maps = {'æ™¯é»':'fa-solid fa-camera','åƒé£¯':'fa-solid fa-utensils','é€›è¡—':'fa-solid fa-bag-shopping','äº¤é€š':'fa-solid fa-train','å½ˆæ€§':'fa-solid fa-star'};
            return maps[t] || 'fa-solid fa-location-dot';
        },
        getWeatherIcon(code) {
            if(code === 0) return 'fa-solid fa-sun text-yellow-400';
            if(code < 4) return 'fa-solid fa-cloud-sun text-gray-300';
            return 'fa-solid fa-cloud-showers-heavy text-blue-300';
        },
        openMap(loc) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank'); },
        saveToLocal() { localStorage.setItem('tokyo_ultra_v3', JSON.stringify({ i: this.itinerary, s: this.startDate })); },
        initSortable() {
            const el = this.$refs.sortableList;
            Sortable.create(el, {
                animation: 200,
                delay: 200, // é•·æŒ‰ 0.2 ç§’
                delayOnTouchOnly: true,
                ghostClass: 'sortable-ghost',
                onEnd: (evt) => {
                    const currEvents = this.itinerary[this.activeDayIdx].events;
                    const item = currEvents.splice(evt.oldIndex, 1)[0];
                    currEvents.splice(evt.newIndex, 0, item);
                    this.saveToLocal();
                }
            });
        }
    },
    mounted() {
        const saved = JSON.parse(localStorage.getItem('tokyo_ultra_v3'));
        if(saved) { this.itinerary = saved.i; this.startDate = saved.s; }
        this.updateTime();
        setInterval(this.updateTime, 10000);
        this.fetchWeather();
        this.initSortable();
    }
}).mount('#app');
</script>
</body>
</html>