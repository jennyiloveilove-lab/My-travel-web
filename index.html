<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…æ—¥è¨˜ Pro ğŸŒ¸</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f0f9f9; font-family: 'Zen Maru Gothic', sans-serif; color: #2d5a5a; }
        .app-container { max-width: 480px; margin: 0 auto; background: #ffffff; min-height: 100vh; position: relative; padding-bottom: 120px; }
        .bg-aqua { background-color: #64cccc; }
        .day-tab-active { background-color: white !important; color: #64cccc !important; transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .day-tab-normal { background-color: rgba(255,255,255,0.2) !important; color: white !important; }
        .kawaii-card { border-radius: 20px; border: 2px solid #f5fbfb; background: #fff; overflow: hidden; }
        .img-preview-container { width: 100%; aspect-ratio: 16/9; border-radius: 15px; margin-top: 10px; overflow: hidden; border: 1px solid #eee; }
        .img-preview { width: 100%; height: 100%; object-fit: cover; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
    </style>
</head>
<body>

<div id="app" class="app-container">
    <header class="bg-aqua text-white p-6 rounded-b-[2.5rem] shadow-lg sticky top-0 z-20">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-xl font-bold flex items-center gap-2">
                    {{ currentTime }} 
                    <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded-full">{{ currentLocationName }}</span>
                </h1>
                <div @click="getLocation" class="flex items-center mt-3 text-sm bg-white/20 p-3 rounded-2xl backdrop-blur-sm cursor-pointer active:opacity-60">
                    <i v-if="weather" :class="getWeatherIcon(weather.code)" class="text-xl mr-2"></i>
                    <div v-if="weather">
                        <p class="font-bold">{{ weather.temp }}Â°C <span class="text-[10px] font-normal opacity-80">æ–¼ç•¶åœ°</span></p>
                        <p class="text-[10px] opacity-90">{{ travelTip }}</p>
                    </div>
                    <div v-else class="text-xs">
                        <i class="fa-solid fa-location-dot animate-bounce mr-2"></i>é»æ“Šç²å–å®šä½èˆ‡å¤©æ°£
                    </div>
                </div>
            </div>
            <button @click="showDateSettings = true" class="bg-white/30 p-3 rounded-full active:scale-90 transition-all">
                <i class="fa-solid fa-calendar-alt"></i>
            </button>
        </div>

        <div class="flex space-x-2 overflow-x-auto no-scrollbar mt-6 py-1">
            <button v-for="(day, i) in itinerary" :key="i" @click="activeDayIdx = i"
                :class="activeDayIdx === i ? 'day-tab-active' : 'day-tab-normal'"
                class="px-4 py-2 rounded-2xl text-xs font-bold flex-shrink-0 transition-all flex flex-col items-center min-w-[85px]">
                <span class="text-[9px] opacity-70">{{ getDayOfWeek(i) }}</span>
                <span class="text-base">{{ getDisplayDate(i) }}</span>
            </button>
            <button @click="addDay" class="px-5 py-2 bg-white/10 rounded-2xl border-2 border-dashed border-white/30">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>
    </header>

    <main class="p-4">
        <div class="scroll-y-container" ref="sortableList">
            <div v-for="(event, eIdx) in itinerary[activeDayIdx].events" :key="event.id" 
                class="kawaii-card p-5 mb-4 shadow-sm border-l-[6px] border-[#64cccc]"
                @click="openEditModal(eIdx)">
                <div class="flex justify-between items-start">
                    <span class="text-[10px] font-bold bg-teal-50 text-[#64cccc] px-2 py-1 rounded-md">{{ event.time }}</span>
                    <span v-if="event.cost > 0" class="text-xs font-bold text-rose-400">Â¥ {{ event.cost.toLocaleString() }}</span>
                </div>
                <h3 class="font-bold text-[#2d5a5a] text-lg mt-2">{{ event.location }}</h3>
                <p v-if="event.note" class="text-xs text-[#88babb] mt-1">{{ event.note }}</p>
                <div v-if="event.image" class="img-preview-container">
                    <img :src="event.image" class="img-preview">
                </div>
            </div>
        </div>
    </main>

    <button @click="addNewEvent" class="fixed bottom-32 right-6 bg-[#64cccc] text-white w-14 h-14 rounded-full shadow-2xl z-30 flex items-center justify-center text-2xl active:scale-90 transition-all">
        <i class="fa-solid fa-plus"></i>
    </button>

    <div v-if="showDateSettings" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl animate-slide-up">
            <h3 class="font-bold text-xl text-center mb-6">è¨­å®šå‡ºç™¼æ—¥æœŸ</h3>
            <input v-model="startDate" type="date" class="w-full p-4 bg-[#f0f9f9] rounded-2xl border-none outline-none font-bold text-center text-[#2d5a5a] mb-6">
            <button @click="showDateSettings = false; saveToLocal();" class="w-full bg-[#64cccc] text-white py-4 rounded-2xl font-bold shadow-lg">ç¢ºèªæ—¥æœŸ</button>
        </div>
    </div>

    <div v-if="showEditModal" class="fixed inset-0 bg-black/50 z-[90] flex items-end">
        <div class="bg-white w-full rounded-t-[3rem] p-8 animate-slide-up max-h-[90vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">{{ isNew ? 'âœ¨ æ–°å¢è¡Œç¨‹' : 'ğŸ“ ç·¨è¼¯è¡Œç¨‹' }}</h3>
                <i @click="showEditModal = false" class="fa-solid fa-xmark text-gray-300 text-2xl cursor-pointer"></i>
            </div>
            
            <div class="space-y-4">
                <div class="flex gap-2">
                    <input v-model="editingEvent.time" type="time" class="p-4 bg-[#f0f9f9] rounded-2xl flex-1 text-sm outline-none">
                    <input v-model="editingEvent.location" type="text" placeholder="å»é‚Šåº¦ï¼Ÿ" class="p-4 bg-[#f0f9f9] rounded-2xl flex-[2] font-bold text-sm outline-none">
                </div>
                
                <textarea v-model="editingEvent.note" placeholder="æœ‰å’©è¦è¨˜ä½ï¼Ÿ" class="w-full p-4 bg-[#f0f9f9] rounded-2xl h-24 text-sm outline-none"></textarea>
                
                <div class="flex items-center bg-[#f0f9f9] p-4 rounded-2xl">
                    <span class="text-[#88babb] font-bold mr-3">Â¥</span>
                    <input v-model.number="editingEvent.cost" type="number" placeholder="èŠ±è²»é‡‘é¡" class="bg-transparent flex-1 outline-none font-bold text-sm">
                </div>

                <div class="pt-2">
                    <label class="block text-[10px] font-bold text-[#88babb] uppercase mb-2 ml-1">è¡Œç¨‹ç›¸ç‰‡</label>
                    <div v-if="editingEvent.image" class="relative group">
                        <img :src="editingEvent.image" class="img-preview-container img-preview">
                        <button @click="editingEvent.image = null" class="absolute top-4 right-4 bg-black/50 text-white w-10 h-10 rounded-full backdrop-blur-sm">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                    <label v-else class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-[#64cccc] rounded-2xl bg-[#f0f9f9] cursor-pointer hover:bg-[#e6f4f4] transition-colors">
                        <i class="fa-solid fa-camera text-2xl text-[#64cccc] mb-2"></i>
                        <span class="text-xs text-[#64cccc] font-bold">åŠ å…¥ç›¸ç‰‡ / å½±ç›¸</span>
                        <input type="file" @change="handleImageUpload" class="hidden" accept="image/*">
                    </label>
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button v-if="!isNew" @click="deleteCurrentEvent" class="flex-1 py-4 text-rose-400 font-bold bg-rose-50 rounded-2xl active:scale-95 transition-all">åˆªé™¤</button>
                <button @click="saveEdit" class="flex-[2] bg-[#64cccc] text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all">å„²å­˜è¡Œç¨‹</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;
createApp({
    data() {
        return {
            activeDayIdx: 0,
            showEditModal: false,
            showDateSettings: false,
            isNew: false,
            editingIdx: -1,
            currentTime: '',
            currentLocationName: 'æœªå®šä½',
            lat: null, lon: null,
            startDate: new Date().toISOString().substr(0, 10),
            weather: null,
            itinerary: [{ events: [] }],
            editingEvent: { id: 0, time: '12:00', location: '', cost: 0, note: '', image: null }
        }
    },
    methods: {
        // å¢å¼·ç‰ˆå®šä½åŠŸèƒ½
        getLocation() {
            this.currentLocationName = "å®šä½ä¸­...";
            if (!navigator.geolocation) {
                this.currentLocationName = "ä¸æ”¯æ´å®šä½";
                this.lat = 35.6895; this.lon = 139.6917; // é è¨­æ±äº¬
                this.fetchWeather();
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    this.lat = pos.coords.latitude;
                    this.lon = pos.coords.longitude;
                    this.currentLocationName = "ç•¶å‰ä½ç½®";
                    this.fetchWeather();
                },
                (err) => {
                    console.error(err);
                    this.currentLocationName = "å®šä½å¤±æ•—";
                    // å¤±æ•—æ™‚é è¨­é¡¯ç¤ºæ±äº¬å¤©æ°£
                    this.lat = 35.6895; this.lon = 139.6917;
                    this.fetchWeather();
                    alert("ç„¡æ³•ç²å–ä½ç½®ã€‚è«‹ç¢ºèªæ˜¯å¦é–‹å•Ÿäº† GPS æ¬Šé™æˆ–ä½¿ç”¨ HTTPS é€£ç·šã€‚");
                },
                { timeout: 8000 }
            );
        },
        async fetchWeather() {
            if (!this.lat) return;
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${this.lat}&longitude=${this.lon}&current_weather=true`);
                const data = await res.json();
                this.weather = { temp: Math.round(data.current_weather.temperature), code: data.current_weather.weathercode };
            } catch (e) { console.error("å¤©æ°£ç²å–å¤±æ•—"); }
        },
        updateTime() {
            const now = new Date();
            this.currentTime = now.toLocaleTimeString('zh-HK', { hour12: false, hour: '2-digit', minute: '2-digit' });
        },
        // ğŸ“¸ è™•ç†åœ–ç‰‡è®€å–
        handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            // æª¢æŸ¥æª”æ¡ˆå¤§å° (å»ºè­°é™åˆ¶åœ¨ 2MB ä»¥å…§ï¼Œé¿å… localStorage çˆ†æ‰)
            if (file.size > 2 * 1024 * 1024) {
                alert("åœ–ç‰‡å¤ªå¤§å–‡ï¼è«‹é¸æ“‡ 2MB ä»¥ä¸‹å˜…ç›¸ç‰‡ã€‚");
                return;
            }
            const reader = new FileReader();
            reader.onload = (f) => { this.editingEvent.image = f.target.result; };
            reader.readAsDataURL(file);
        },
        getDisplayDate(i) {
            const d = new Date(this.startDate);
            d.setDate(d.getDate() + i);
            return `${d.getMonth() + 1}/${d.getDate()}`;
        },
        getDayOfWeek(i) {
            const d = new Date(this.startDate);
            d.setDate(d.getDate() + i);
            const days = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'];
            return days[d.getDay()];
        },
        getWeatherIcon(code) {
            if(code === 0) return 'fa-solid fa-sun text-yellow-400';
            if(code < 4) return 'fa-solid fa-cloud-sun text-gray-400';
            return 'fa-solid fa-cloud-rain text-blue-300';
        },
        openEditModal(idx) {
            this.isNew = false; this.editingIdx = idx;
            this.editingEvent = JSON.parse(JSON.stringify(this.itinerary[this.activeDayIdx].events[idx]));
            this.showEditModal = true;
        },
        addNewEvent() {
            this.isNew = true;
            this.editingEvent = { id: Date.now(), time: '12:00', location: '', cost: 0, note: '', image: null };
            this.showEditModal = true;
        },
        saveEdit() {
            if(!this.editingEvent.location) return;
            if(this.isNew) this.itinerary[this.activeDayIdx].events.push({...this.editingEvent});
            else this.itinerary[this.activeDayIdx].events[this.editingIdx] = {...this.editingEvent};
            this.itinerary[this.activeDayIdx].events.sort((a,b) => a.time.localeCompare(b.time));
            this.showEditModal = false; this.saveToLocal();
        },
        deleteCurrentEvent() {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
                this.itinerary[this.activeDayIdx].events.splice(this.editingIdx, 1);
                this.showEditModal = false; this.saveToLocal();
            }
        },
        addDay() { this.itinerary.push({ events: [] }); this.activeDayIdx = this.itinerary.length - 1; this.saveToLocal(); },
        saveToLocal() { 
            try {
                localStorage.setItem('travel_pro_v7', JSON.stringify({ i: this.itinerary, s: this.startDate })); 
            } catch (e) {
                alert("å„²å­˜ç©ºé–“ä¸è¶³ï¼ˆå¯èƒ½ä¿‚ç›¸ç‰‡å¤ªå¤šï¼‰ï¼Œè«‹åˆªé™¤éƒ¨åˆ†ç›¸ç‰‡å¾Œå†è©¦ã€‚");
            }
        }
    },
    computed: {
        travelTip() {
            if (!this.weather) return "";
            return this.weather.code < 4 ? "â˜€ï¸ å¤©æ°£å””éŒ¯ï¼Œå•±æ™’å‡ºé–€ï¼" : "â˜” å¸¶è¿”æŠŠé®ï¼Œå°å¿ƒæ·‹è¦ªã€‚";
        }
    },
    mounted() {
        const saved = JSON.parse(localStorage.getItem('travel_pro_v7'));
        if(saved) { this.itinerary = saved.i; this.startDate = saved.s; }
        this.updateTime(); setInterval(this.updateTime, 10000); 
        this.getLocation(); // å•Ÿå‹•æ™‚è‡ªå‹•å˜—è©¦å®šä½
        Sortable.create(this.$refs.sortableList, {
            animation: 200, delay: 200, delayOnTouchOnly: true,
            onEnd: (evt) => {
                const curr = this.itinerary[this.activeDayIdx].events;
                const item = curr.splice(evt.oldIndex, 1)[0];
                curr.splice(evt.newIndex, 0, item);
                this.saveToLocal();
            }
        });
    }
}).mount('#app');
</script>
</body>
</html>