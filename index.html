<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…æ—¥è¨˜ Pro V15 ğŸŒ¸</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f8fbfb; font-family: 'Zen Maru Gothic', sans-serif; color: #2d5a5a; -webkit-tap-highlight-color: transparent; }
        .app-container { max-width: 480px; margin: 0 auto; background: #ffffff; min-height: 100vh; position: relative; padding-bottom: 120px; }
        .bg-aqua { background-color: #64cccc; }
        .day-tab-active { background-color: white !important; color: #64cccc !important; box-shadow: 0 4px 15px rgba(100,204,204,0.2); }
        .day-tab-normal { background-color: rgba(255,255,255,0.2) !important; color: white !important; }
        .kawaii-card { border-radius: 28px; background: #fff; border: 1px solid #f0f7f7; box-shadow: 0 6px 20px rgba(0,0,0,0.03); }
        .expense-badge { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

<div id="app" class="app-container">
    <header class="bg-aqua text-white p-6 rounded-b-[3.5rem] shadow-lg sticky top-0 z-20">
        <div class="flex justify-between items-start">
            <div class="flex-1">
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    {{ currentTime }} 
                    <span class="text-[11px] bg-black/10 px-3 py-1 rounded-full font-normal">{{ currentLocationName }}</span>
                </h1>
                <p class="text-[10px] mt-2 opacity-90 font-bold"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i>{{ travelTip }}</p>
            </div>
            <button @click="showSettings = true" class="bg-white/30 w-11 h-11 rounded-full flex items-center justify-center active:scale-90 shadow-inner">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>

        <div class="flex space-x-3 overflow-x-auto no-scrollbar mt-6 py-2">
            <button v-for="(day, i) in itinerary" :key="i" @click="activeDayIdx = i"
                :class="activeDayIdx === i ? 'day-tab-active' : 'day-tab-normal'"
                class="px-4 py-3 rounded-2xl text-xs font-bold flex-shrink-0 flex flex-col items-center min-w-[100px] transition-all">
                <span class="text-[9px] uppercase opacity-70 mb-0.5">Day {{ i + 1 }}</span>
                <span class="text-base">{{ getDisplayDate(i) }}</span>
                <span class="text-[10px] font-normal opacity-80">{{ getDayOfWeek(i) }}</span>
            </button>
            <button @click="addDay" class="px-6 py-3 bg-white/10 rounded-2xl border-2 border-dashed border-white/40"><i class="fa-solid fa-plus"></i></button>
        </div>
    </header>

    <main class="p-5 space-y-8">
        
        <section v-if="itinerary[activeDayIdx].events.some(e => e.cost > 0)" class="space-y-4">
            <div class="flex items-center gap-2 px-1">
                <i class="fa-solid fa-chart-pie text-[#64cccc]"></i>
                <h2 class="font-bold text-lg text-[#2d5a5a]">æ¯æ—¥é–‹æ”¯å ±è¡¨</h2>
            </div>
            
            <div class="bg-[#f0f9f9] rounded-[2.5rem] p-6 space-y-6">
                <div class="flex justify-between items-end border-b border-[#64cccc]/20 pb-4">
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Today's Total</p>
                        <p class="text-3xl font-black text-[#64cccc]">Â¥ {{ dailyTotal.toLocaleString() }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-gray-400 font-bold uppercase">HKD Reference</p>
                        <p class="text-xl font-bold text-rose-400">â‰ˆ ${{ (dailyTotal * exchangeRate).toFixed(0) }}</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div v-for="stat in categoryStats" :key="stat.name" class="bg-white/60 p-3 rounded-2xl flex items-center justify-between">
                        <span class="text-xs">{{ stat.emoji }} {{ stat.name }}</span>
                        <span class="text-xs font-bold">Â¥{{ stat.total }}</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="space-y-4">
            <div class="flex items-center gap-2 px-1">
                <i class="fa-solid fa-route text-[#64cccc]"></i>
                <h2 class="font-bold text-lg text-[#2d5a5a]">è¡Œç¨‹å®‰æ’</h2>
            </div>
            
            <div ref="sortableList" class="space-y-5">
                <div v-for="(event, eIdx) in itinerary[activeDayIdx].events" :key="event.id" 
                    class="kawaii-card p-5 relative border-l-[10px]" :style="{ borderColor: getCategoryColor(event.category) }"
                    @click="openEditModal(eIdx)">
                    
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-black bg-[#f0f9f9] text-[#64cccc] px-3 py-1 rounded-lg">{{ event.time }}</span>
                            <span class="text-sm font-bold">{{ getCategoryEmoji(event.category) }}</span>
                        </div>
                        <div v-if="event.cost > 0" class="text-right">
                            <span class="text-sm font-bold text-rose-400">Â¥{{ event.cost.toLocaleString() }}</span>
                        </div>
                    </div>

                    <h3 class="font-bold text-[#2d5a5a] text-xl">{{ event.location }}</h3>
                    <img v-if="event.image" :src="event.image" class="w-full aspect-video object-cover rounded-2xl mt-3">

                    <div class="flex justify-between items-center mt-4">
                        <p class="text-xs text-gray-400 italic flex-1 line-clamp-1 mr-4">{{ event.note || 'å†‡å‚™è¨»' }}</p>
                        <button @click.stop="openGoogleMap(event.location)" class="bg-[#64cccc]/10 text-[#64cccc] px-4 py-2 rounded-full text-[10px] font-black">
                            <i class="fa-solid fa-location-arrow mr-1"></i> MAP
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <button @click="addNewEvent" class="fixed bottom-10 right-8 bg-[#64cccc] text-white w-16 h-16 rounded-full shadow-2xl z-30 flex items-center justify-center text-3xl active:scale-90 transition-all">
        <i class="fa-solid fa-plus"></i>
    </button>

    <div v-if="showSettings" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-8">
        <div class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl">
            <h3 class="font-bold text-xl text-center mb-6">âš™ï¸ æ—…è¡Œè¨­å®š</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">é¦–æ—¥æ—¥æœŸ</label>
                    <input v-model="startDate" type="date" class="w-full p-4 bg-[#f0f9f9] rounded-2xl font-bold">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">åŒ¯ç‡ (1 JPY å…Œ HKD)</label>
                    <input v-model.number="exchangeRate" type="number" step="0.001" class="w-full p-4 bg-[#f0f9f9] rounded-2xl font-bold">
                </div>
            </div>
            <button @click="showSettings = false; saveToLocal();" class="w-full bg-[#64cccc] text-white py-4 rounded-2xl font-bold mt-8 shadow-lg">å„²å­˜ä¸¦è¿”å›</button>
        </div>
    </div>

    <div v-if="showEditModal" class="fixed inset-0 bg-black/50 z-[90] flex items-end">
        <div class="bg-white w-full rounded-t-[3rem] p-8 max-h-[92vh] overflow-y-auto no-scrollbar shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-2xl text-[#2d5a5a]">{{ isNew ? 'âœ¨ æ–°è¡Œç¨‹' : 'ğŸ“ ç·¨è¼¯' }}</h3>
                <i @click="showEditModal = false" class="fa-solid fa-xmark text-gray-300 text-2xl p-2"></i>
            </div>
            
            <div class="space-y-5">
                <div class="flex gap-2 overflow-x-auto no-scrollbar py-2">
                    <button v-for="cat in categories" :key="cat.id" @click="editingEvent.category = cat.id"
                        :class="editingEvent.category === cat.id ? 'bg-[#64cccc] text-white' : 'bg-[#f0f9f9] text-gray-400'"
                        class="px-5 py-3 rounded-2xl text-xs font-bold flex-shrink-0 flex flex-col items-center min-w-[75px] transition-all">
                        <span class="text-xl mb-1">{{ cat.emoji }}</span>{{ cat.name }}
                    </button>
                </div>

                <div class="flex gap-3">
                    <input v-model="editingEvent.time" type="time" class="p-4 bg-[#f0f9f9] rounded-2xl flex-1 outline-none text-lg">
                    <input v-model="editingEvent.location" type="text" placeholder="å»é‚Šåº¦ï¼Ÿ" class="p-4 bg-[#f0f9f9] rounded-2xl flex-[2.5] font-bold outline-none">
                </div>
                
                <textarea v-model="editingEvent.note" placeholder="å‚™è¨»..." class="w-full p-5 bg-[#f0f9f9] rounded-2xl h-24 text-sm outline-none resize-none"></textarea>
                
                <div class="bg-[#f0f9f9] p-5 rounded-3xl">
                    <div class="flex items-center">
                        <span class="text-[#64cccc] font-black mr-4 text-xl">Â¥</span>
                        <input v-model.number="editingEvent.cost" type="number" placeholder="æ—¥åœ“é–‹æ”¯" class="bg-transparent flex-1 outline-none font-bold text-2xl">
                    </div>
                    <div class="mt-2 text-xs text-gray-400 font-bold border-t border-white pt-2 flex justify-between">
                        <span>æ›ç®—æ¸¯å¹£</span>
                        <span class="text-rose-400">â‰ˆ HK$ {{ (editingEvent.cost * exchangeRate).toFixed(1) }}</span>
                    </div>
                </div>

                <div v-if="editingEvent.image" class="relative">
                    <img :src="editingEvent.image" class="w-full rounded-2xl shadow-md">
                    <button @click="editingEvent.image = null" class="absolute top-4 right-4 bg-black/60 text-white w-9 h-9 rounded-full flex items-center justify-center"><i class="fa-solid fa-trash-can text-sm"></i></button>
                </div>
                <label v-else class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-[#64cccc] rounded-[2rem] bg-[#f0f9f9] cursor-pointer active:scale-95 transition-all">
                    <i class="fa-solid fa-camera text-[#64cccc] text-2xl mb-2"></i>
                    <span class="text-[10px] font-black text-[#64cccc] uppercase">åŠ å…¥ç›¸ç‰‡ / å½±ç›¸</span>
                    <input type="file" @change="uploadPhoto" class="hidden" accept="image/*">
                </label>
            </div>

            <div class="flex gap-4 mt-8">
                <button v-if="!isNew" @click="deleteEvent" class="flex-1 py-4 text-rose-400 font-bold bg-rose-50 rounded-2xl">åˆªé™¤</button>
                <button @click="saveEvent" class="flex-[2.5] bg-[#64cccc] text-white py-4 rounded-2xl font-bold shadow-lg">å„²å­˜è¡Œç¨‹</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;
createApp({
    data() {
        return {
            activeDayIdx: 0,
            showEditModal: false,
            showSettings: false,
            isNew: false,
            editingIdx: -1,
            currentTime: '',
            currentLocationName: 'æ±äº¬',
            lat: 35.6895, lon: 139.6917,
            startDate: new Date().toISOString().substr(0, 10),
            exchangeRate: 0.052,
            weather: null,
            itinerary: [{ events: [] }],
            categories: [
                { id: 'spot', name: 'æ™¯é»', emoji: 'ğŸŒ¸', color: '#64cccc' },
                { id: 'eat', name: 'é£²é£Ÿ', emoji: 'ğŸ±', color: '#ffb347' },
                { id: 'shop', name: 'è³¼ç‰©', emoji: 'ğŸ›ï¸', color: '#f4a460' },
                { id: 'transport', name: 'äº¤é€š', emoji: 'ğŸšƒ', color: '#88babb' },
                { id: 'flex', name: 'å½ˆæ€§', emoji: 'ğŸˆ', color: '#d3d3d3' }
            ],
            editingEvent: { id: 0, time: '12:00', location: '', cost: 0, note: '', image: null, category: 'spot' }
        }
    },
    methods: {
        async getLocation() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(async (pos) => {
                this.lat = pos.coords.latitude; this.lon = pos.coords.longitude;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${this.lat}&lon=${this.lon}&accept-language=zh-HK`);
                    const data = await res.json();
                    this.currentLocationName = data.address.suburb || data.address.city || "ç•¶å‰ä½ç½®";
                } catch (e) {}
                this.fetchWeather();
            });
        },
        async fetchWeather() {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${this.lat}&longitude=${this.lon}&current_weather=true`);
            const data = await res.json();
            this.weather = { temp: Math.round(data.current_weather.temperature), code: data.current_weather.weathercode };
        },
        openGoogleMap(loc) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank'); },
        uploadPhoto(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (f) => { this.editingEvent.image = f.target.result; };
            reader.readAsDataURL(file);
        },
        getCategoryEmoji(id) { return this.categories.find(c => c.id === id)?.emoji || 'ğŸ“'; },
        getCategoryColor(id) { return this.categories.find(c => c.id === id)?.color || '#64cccc'; },
        getDisplayDate(i) {
            const d = new Date(this.startDate);
            d.setDate(d.getDate() + i);
            return `${(d.getMonth() + 1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
        },
        getDayOfWeek(i) {
            const d = new Date(this.startDate); d.setDate(d.getDate() + i);
            return ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][d.getDay()];
        },
        addNewEvent() {
            this.isNew = true;
            this.editingEvent = { id: Date.now(), time: '12:00', location: '', cost: 0, note: '', image: null, category: 'spot' };
            this.showEditModal = true;
        },
        openEditModal(idx) {
            this.isNew = false; this.editingIdx = idx;
            this.editingEvent = JSON.parse(JSON.stringify(this.itinerary[this.activeDayIdx].events[idx]));
            this.showEditModal = true;
        },
        saveEvent() {
            if(!this.editingEvent.location) return;
            if(this.isNew) this.itinerary[this.activeDayIdx].events.push({...this.editingEvent});
            else this.itinerary[this.activeDayIdx].events[this.editingIdx] = {...this.editingEvent};
            this.itinerary[this.activeDayIdx].events.sort((a,b) => a.time.localeCompare(b.time));
            this.showEditModal = false; this.saveToLocal();
        },
        deleteEvent() {
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { this.itinerary[this.activeDayIdx].events.splice(this.editingIdx, 1); this.showEditModal = false; this.saveToLocal(); }
        },
        addDay() { this.itinerary.push({ events: [] }); this.activeDayIdx = this.itinerary.length - 1; this.saveToLocal(); },
        updateTime() {
            this.currentTime = new Date().toLocaleTimeString('zh-HK', { hour12: false, hour: '2-digit', minute: '2-digit' });
        },
        saveToLocal() { localStorage.setItem('travel_pro_v15', JSON.stringify({ i: this.itinerary, s: this.startDate, r: this.exchangeRate })); }
    },
    computed: {
        dailyTotal() { return this.itinerary[this.activeDayIdx].events.reduce((sum, e) => sum + (Number(e.cost) || 0), 0); },
        categoryStats() {
            return this.categories.map(cat => {
                const total = this.itinerary[this.activeDayIdx].events
                    .filter(e => e.category === cat.id)
                    .reduce((sum, e) => sum + (Number(e.cost) || 0), 0);
                return { ...cat, total };
            }).filter(s => s.total > 0);
        },
        travelTip() { 
            if(!this.weather) return "æ­£åœ¨æº–å‚™æ—…ç¨‹...";
            return this.weather.code < 4 ? "å¤©æ°£æ¸…çˆ½ï¼Œé©åˆå½±ç›¸ï¼" : "æœƒæœ‰é›¨ï¼Œå»ºè­°å®¤å…§è¡Œç¨‹ã€‚";
        }
    },
    mounted() {
        const saved = JSON.parse(localStorage.getItem('travel_pro_v15'));
        if(saved) { this.itinerary = saved.i; this.startDate = saved.s; this.exchangeRate = saved.r || 0.052; }
        this.updateTime(); setInterval(this.updateTime, 10000); this.getLocation();
        Sortable.create(this.$refs.sortableList, { animation: 200, delay: 200, delayOnTouchOnly: true, onEnd: (evt) => {
            const curr = this.itinerary[this.activeDayIdx].events;
            const item = curr.splice(evt.oldIndex, 1)[0];
            curr.splice(evt.newIndex, 0, item);
            this.saveToLocal();
        }});
    }
}).mount('#app');
</script>
</body>
</html>